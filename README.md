<p align="center">
  <svg height="300pt" viewBox="0 -36 512 512" width="512pt" xmlns="http://www.w3.org/2000/svg"><path d="m144 392c-2.207031 0-4-1.792969-4-4v-68.089844c0-28.863281 14.535156-55.359375 38.894531-70.863281l45.648438-29.046875-45.648438-29.046875c-24.359375-15.503906-38.894531-42-38.894531-70.863281v-68.089844c0-2.207031 1.792969-4 4-4s4 1.792969 4 4v68.089844c0 26.117187 13.160156 50.085937 35.191406 64.117187l50.953125 32.425781c1.160157.726563 1.855469 2 1.855469 3.367188s-.695312 2.640625-1.847656 3.375l-50.953125 32.425781c-22.039063 14.03125-35.191407 38-35.191407 64.121094v68.078125c-.007812 2.207031-1.800781 4-4.007812 4zm0 0" fill="#263238"/><path d="m319.640625 249.222656c-.746094 0-1.488281-.199218-2.152344-.621094l-39.640625-25.226562c-1.152344-.734375-1.847656-2.007812-1.847656-3.375s.695312-2.640625 1.847656-3.375l50.953125-32.425781c22.039063-14.03125 35.191407-38 35.191407-64.121094v-68.078125c0-2.207031 1.792968-4 4-4 2.207031 0 4 1.792969 4 4v68.089844c0 28.863281-14.535157 55.359375-38.894532 70.863281l-45.640625 29.046875 34.335938 21.847656c1.855469 1.183594 2.414062 3.65625 1.222656 5.519532-.769531 1.199218-2.054687 1.855468-3.375 1.855468zm0 0" fill="#263238"/><path d="m318.070312 171.328125c-1.316406 0-2.605468-.65625-3.375-1.847656-1.183593-1.863281-.640624-4.335938 1.226563-5.519531 15.078125-9.601563 24.078125-26 24.078125-43.863282v-60.097656c0-2.207031 1.792969-4 4-4s4 1.792969 4 4v60.089844c0 20.613281-10.382812 39.535156-27.785156 50.613281-.664063.425781-1.398438.625-2.144532.625zm0 0" fill="#263238"/><path d="m367.105469 312c-1.945313 0-3.648438-1.425781-3.945313-3.40625-2.34375-15.554688-9.328125-29.800781-20.199218-41.179688-1.527344-1.597656-1.472657-4.132812.128906-5.652343 1.605468-1.53125 4.132812-1.464844 5.652344.125 12.027343 12.585937 19.746093 28.320312 22.328124 45.519531.328126 2.179688-1.167968 4.21875-3.359374 4.546875-.214844.03125-.40625.046875-.605469.046875zm0 0" fill="#263238"/><path d="m376 4h-240c-8.839844 0-16 7.160156-16 16s7.160156 16 16 16h240c8.839844 0 16-7.160156 16-16s-7.160156-16-16-16zm0 0" fill="#40c4ff"/><g fill="#263238"><path d="m376 40h-240c-11.03125 0-20-8.96875-20-20s8.96875-20 20-20h240c11.03125 0 20 8.96875 20 20s-8.96875 20-20 20zm-240-32c-6.617188 0-12 5.382812-12 12s5.382812 12 12 12h240c6.617188 0 12-5.382812 12-12s-5.382812-12-12-12zm0 0"/><path d="m476 224h-72c-2.207031 0-4-1.792969-4-4s1.792969-4 4-4h72c2.207031 0 4 1.792969 4 4s-1.792969 4-4 4zm0 0"/><path d="m508 224h-16c-2.207031 0-4-1.792969-4-4s1.792969-4 4-4h16c2.207031 0 4 1.792969 4 4s-1.792969 4-4 4zm0 0"/><path d="m108 224h-72c-2.207031 0-4-1.792969-4-4s1.792969-4 4-4h72c2.207031 0 4 1.792969 4 4s-1.792969 4-4 4zm0 0"/><path d="m20 224h-16c-2.207031 0-4-1.792969-4-4s1.792969-4 4-4h16c2.207031 0 4 1.792969 4 4s-1.792969 4-4 4zm0 0"/><path d="m480 56h-32c-2.207031 0-4-1.792969-4-4s1.792969-4 4-4h32c2.207031 0 4 1.792969 4 4s-1.792969 4-4 4zm0 0"/><path d="m464 72c-2.207031 0-4-1.792969-4-4v-32c0-2.207031 1.792969-4 4-4s4 1.792969 4 4v32c0 2.207031-1.792969 4-4 4zm0 0"/><path d="m440 108h-32c-2.207031 0-4-1.792969-4-4s1.792969-4 4-4h32c2.207031 0 4 1.792969 4 4s-1.792969 4-4 4zm0 0"/><path d="m424 124c-2.207031 0-4-1.792969-4-4v-32c0-2.207031 1.792969-4 4-4s4 1.792969 4 4v32c0 2.207031-1.792969 4-4 4zm0 0"/></g><path d="m404 436h-88c-11.046875 0-20-8.953125-20-20v-72c0-11.046875 8.953125-20 20-20h88c11.046875 0 20 8.953125 20 20v72c0 11.046875-8.953125 20-20 20zm0 0" fill="#ffd740"/><path d="m404 440h-88c-13.230469 0-24-10.769531-24-24v-72c0-13.230469 10.769531-24 24-24h88c13.230469 0 24 10.769531 24 24v72c0 13.230469-10.769531 24-24 24zm-88-112c-8.824219 0-16 7.175781-16 16v72c0 8.824219 7.175781 16 16 16h88c8.824219 0 16-7.175781 16-16v-72c0-8.824219-7.175781-16-16-16zm0 0" fill="#263238"/><path d="m280 426.648438v-22.648438h-144c-8.839844 0-16 7.160156-16 16 0 8.832031 7.160156 16 16 16h145.832031c-1.152343-2.902344-1.832031-6.039062-1.832031-9.351562zm0 0" fill="#40c4ff"/><path d="m281.832031 440h-145.832031c-11.03125 0-20-8.96875-20-20s8.96875-20 20-20h144c2.207031 0 4 1.792969 4 4s-1.792969 4-4 4h-144c-6.617188 0-12 5.382812-12 12s5.382812 12 12 12h145.832031c2.207031 0 4 1.792969 4 4s-1.785156 4-4 4zm0 0" fill="#263238"/><path d="m400 328c-2.207031 0-4-1.792969-4-4v-40c0-19.847656-16.152344-36-36-36s-36 16.152344-36 36v16c0 2.207031-1.792969 4-4 4s-4-1.792969-4-4v-16c0-24.257812 19.742188-44 44-44s44 19.742188 44 44v40c0 2.207031-1.792969 4-4 4zm0 0" fill="#263238"/><path d="m328 364h-32c-2.207031 0-4-1.792969-4-4s1.792969-4 4-4h32c2.207031 0 4 1.792969 4 4s-1.792969 4-4 4zm0 0" fill="#263238"/><path d="m328 404h-32c-2.207031 0-4-1.792969-4-4s1.792969-4 4-4h32c2.207031 0 4 1.792969 4 4s-1.792969 4-4 4zm0 0" fill="#263238"/><path d="m424 364h-32c-2.207031 0-4-1.792969-4-4s1.792969-4 4-4h32c2.207031 0 4 1.792969 4 4s-1.792969 4-4 4zm0 0" fill="#263238"/><path d="m424 404h-32c-2.207031 0-4-1.792969-4-4s1.792969-4 4-4h32c2.207031 0 4 1.792969 4 4s-1.792969 4-4 4zm0 0" fill="#263238"/></svg>
</p>

<h2 align="center">Rate Limiter Module for NestJS</h2>

<p align="center">
<a href="https://www.codefactor.io/repository/github/ozkanonur/nestjs-rate-limiter"><img src="https://www.codefactor.io/repository/github/ozkanonur/nestjs-rate-limiter/badge?style=flat-square&sanitize=true" alt="Code Quality" /></a>
<a href="https://www.npmjs.com/package/nestjs-rate-limiter"><img src="https://img.shields.io/npm/v/nestjs-rate-limiter.svg?style=flat-square&sanitize=true" alt="NPM Version" /></a>
<a href="https://www.npmjs.com/package/nestjs-rate-limiter"><img src="https://img.shields.io/npm/dm/nestjs-rate-limiter.svg?style=flat-square&sanitize=true" alt="NPM Downloads" /></a>
<a href="#"><img src="https://img.shields.io/npm/l/nestjs-rate-limiter.svg?colorB=black&label=LICENSE&style=flat-square&sanitize=true" alt="License"/></a>

</p>

# Description

`nestjs-rate-limiter` is a module which adds in configurable rate limiting for [Nest](https://github.com/nestjs/nest) applications.

Under the hood it uses [rate-limiter-flexible](https://github.com/animir/node-rate-limiter-flexible).

# Installation

```bash
npm i --save nestjs-rate-limiter
```

Or if you use Yarn:

```bash
yarn add nestjs-rate-limiter
```

### Requirements

`nestjs-rate-limiter` is built to work with Nest 6 and newer versions.

# Usage

### Include Module

First you need to import this module into your main application module:

> app.module.ts

```ts
import { RateLimiterModule } from 'nestjs-rate-limiter';

@Module({
    imports: [RateLimiterModule],
})
export class ApplicationModule {}
```

### Using Interceptor

Now you need to register the interceptor. You can do this only on some routes:

> app.controller.ts

```ts
import { RateLimiterInterceptor } from 'nestjs-rate-limiter';

@UseInterceptors(RateLimiterInterceptor)
@Get('/login')
public async login() {
    console.log('hello');
}
```

Or you can choose to register the interceptor globally:

> app.module.ts

```ts
import { APP_INTERCEPTOR } from '@nestjs/core';
import { RateLimiterModule, RateLimiterInterceptor } from 'nestjs-rate-limiter';

@Module({
    imports: [RateLimiterModule],
    providers: [
        {
            provide: APP_INTERCEPTOR,
            useClass: RateLimiterInterceptor,
        },
    ],
})
export class ApplicationModule {}
```

### Decorator

You can use the `@RateLimit` decorator to specify the points and duration for rate limiting on a per controller or per
route basis:

> app.controller.ts

```ts
import { RateLimit } from 'nestjs-rate-limiter';

@RateLimit({ points: 1, duration: 60, errorMessage: 'Accounts cannot be created more than once in per minute' })
@Get('/signup')
public async signUp() {
    console.log('hello');
}
```

The above example would rate limit the `/signup` route to 1 request every 60 seconds.

Note that when passing in options via the decorator, it will combine the options for the module (defined via
`RateLimiterModule.register` or the default ones) along with the decorator options. While this should be fine for most
use cases, if you have defined a global interceptor with a `pointsConsumed` option, that will also apply to all
decorated requests. So if you need to have a different `pointsConsumed` for decorated requests than what you have
defined globally, you must pass it in when writing your decorator.

Also note that if the `keyPrefix` is already in use, it will not update any options, only reuse the existing rate
limiter object when it was last instantiated. This should be fine with the decorators, unless you manually specify a
duplicate `keyPrefix` or reuse the same class and method names with the decorator.

# Configuration

### Constructor Options
| Option Name | Required | Type | Default |
| ------ | ------ | ------ | ------|
| for | false | 'Express' - 'Fastify' - 'Microservice' | 'Express' |
| type | false | 'Memory' - 'Redis' - 'Memcache' - 'Postgres' - 'MySQL' | 'Memory' |
| points | false | number | 4 |
| duration | false | number | 1 |
| pointsConsumed | false | number | 1 |
| keyPrefix | false | string | 'global' |
| errorMessage | false | string | 'Rate limit exceeded' |

To change the settings for `nestjs-rate-limiter`, you can define a `RateLimiterModuleOptions` object when registering
the module:

> app.module.ts

```ts
@Module({
    imports: [
        RateLimiterModule.register({
            for: 'Fastify',
            type: 'Memory',
            points: 15,
            duration: 90,
            pointsConsumed: 1,
            keyPrefix: 'global',
            errorMessage: 'Rate limit exceeded, you have to wait before trying again'
        }),
    ],
    providers: [
        {
            provide: APP_INTERCEPTOR,
            useClass: RateLimiterInterceptor,
        },
    ],
})
export class ApplicationModule {}
```

The above example would rate limit the `/login` route to 1 request every 1 second using an im memory cache.

When defining your options, you can pass through any options supported by `rate-limiter-flexible` in order to setup any
config needed. For a full list see <https://github.com/animir/node-rate-limiter-flexible/wiki/Options>.

The main important options (and the ones used solely by this library) are below.

### for: 'Express' | 'Fastify' | 'Microservice'

This is the value which is based technology of your project. The default Nest applications are Express therefore this value is also comes with Express value as default.

See official documentation for other supported technologies other than Express:

-   [Fastify](https://docs.nestjs.com/techniques/performance)
-   [Microservices](https://docs.nestjs.com/microservices/basics)

### type: 'Memory' | 'Redis' | 'Memcached' | 'Postgres' | 'MySQL'

This is the type of rate limiter that the underlying `rate-limiter-flexible` library will use to keep track of the
requests made by users.

-   [Memory](https://github.com/animir/node-rate-limiter-flexible/wiki/Memory)
-   [Redis](https://github.com/animir/node-rate-limiter-flexible/wiki/Redis)
-   [Memcached](https://github.com/animir/node-rate-limiter-flexible/wiki/Memcached)
-   [Postgres](https://github.com/animir/node-rate-limiter-flexible/wiki/Postgres)
-   [MySQL](https://github.com/animir/node-rate-limiter-flexible/wiki/MySQL)

For examples showing how to define and setup different cache types, see the section in the README.

There are other options that the `rate-limiter-flexible` library supports, but aren't implemented within this library
yet. Feel free to submit a PR adding support for those.

### points: number

This is the number of 'points' the user will be given per period. You can think of points as simply the number of
requests that a user can make in a set period.

The underlying library allows consuming a set amount of points per action, for instance maybe some actions a user can
take, might be more resource intensive, and therefor take up more 'points'.

By default we assume all requests consume 1 point. But this can be set using the `pointsConsumed` configuration option
or via the `@RateLimit` decorator.

### pointsConsumed: number

As mentioned above, you can consume more than 1 point per invocation of the rate limiter.

For instance if you have a limit of 100 points per 60 seconds, and `pointsConsumed` is set to 10, the user will
effectively be able to make 10 requests per 60 seconds.

### duration: number

This is the duration that the rate limiter will enforce the limit of `points` for.

This is defined in seconds, so a value of 60 will be 60 seconds.

### keyPrefix: string

This defines the prefix used for all storage methods listed in the `type` option.

This can be used to define different rate limiting rules to different routes/controllers.

When setting up `nestjs-rate-limiter`, you should make sure that any `keyPrefix` values are unique. If they are not
unique, then they will share the same rate limit.

For instance if you have the decorator on a controller, the `keyPrefix` will be the controllers name. If used on a
route, it will be a combination of the controllers name and the route functions name.


### errorMessage: string

The value that overrides error messages on Rate Limit exceptions.


# Examples

### With Redis

First you must install either the `redis` or `ioredis` package:

```bash
npm install --save redis
```

```bash
npm install --save ioredis
```

Then you must create a client (offline queue must be turned off) and pass it via the `storeClient` config option to
`RateLimiterModule.register`:

> app.module.ts

```ts
import * as redis from 'redis';
const redisClient = redis.createClient({ enable_offline_queue: false });

import * as Redis from 'ioredis';
const redisClient = new Redis({ enableOfflineQueue: false });

@Module({
    imports: [
        RateLimiterModule.register({
            type: 'Redis',
            storeClient: redisClient,
        }),
    ],
    providers: [
        {
            provide: APP_INTERCEPTOR,
            useClass: RateLimiterInterceptor,
        },
    ],
})
export class ApplicationModule {}
```

### With Memcache

First you must install the `memcached` package:

```bash
npm install --save memcached
```

Then you must create a client and pass it via the `storeClient` config option to `RateLimiterModule.register`:

> app.module.ts

```ts
import * as Memcached from 'memcached';
const memcachedClient = new Memcached('127.0.0.1:11211');

@Module({
    imports: [
        RateLimiterModule.register({
            type: 'Memcached',
            storeClient: memcachedClient,
        }),
    ],
    providers: [
        {
            provide: APP_INTERCEPTOR,
            useClass: RateLimiterInterceptor,
        },
    ],
})
export class ApplicationModule {}
```

### With Postgres

First you must install the `pg` package:

```bash
npm install --save pg
```

Then you must create a client and pass it via the `storeClient` config option to `RateLimiterModule.register`:

> app.module.ts

```ts
import { Pool } from 'pg';
const postgresClient = new Pool({
    host: '127.0.0.1',
    port: 5432,
    database: 'root',
    user: 'root',
    password: 'secret',
});

@Module({
    imports: [
        RateLimiterModule.register({
            type: 'Postgres',
            storeClient: postgresClient,
            tableName: 'rate_limiting', // not specifying this will create one table for each keyPrefix
        }),
    ],
    providers: [
        {
            provide: APP_INTERCEPTOR,
            useClass: RateLimiterInterceptor,
        },
    ],
})
export class ApplicationModule {}
```

Note that this limiter also supports using [knex](https://knexjs.org/) or [sequelize](http://docs.sequelizejs.com/) with
an additional parameter as noted at
<https://github.com/animir/node-rate-limiter-flexible/wiki/PostgreSQL#sequelize-and-knex-support>.

### With MySQL

First you must install either the `mysql` or `mysql2` package:

```bash
npm install --save mysql
```

```bash
npm install --save mysql2
```

Then you must create a client and pass it via the `storeClient` config option to `RateLimiterModule.register`:

> app.module.ts

```ts
import * as mysql from 'mysql';

import * as mysql from 'mysql2';

const mysqlClient = mysql.createPool({
    connectionLimit: 100,
    host: 'localhost',
    user: 'root',
    password: 'secret',
});

@Module({
    imports: [
        RateLimiterModule.register({
            type: 'MySQL',
            storeClient: mysqlClient,
            dbName: 'ratelimits',
            tableName: 'rate_limiting', // not specifying this will create one table for each keyPrefix
        }),
    ],
    providers: [
        {
            provide: APP_INTERCEPTOR,
            useClass: RateLimiterInterceptor,
        },
    ],
})
export class ApplicationModule {}
```

Note that this limiter also supports using [knex](https://knexjs.org/) or [sequelize](http://docs.sequelizejs.com/) with
an additional parameter as noted at
<https://github.com/animir/node-rate-limiter-flexible/wiki/MySQL#sequelize-and-knex-support>.
